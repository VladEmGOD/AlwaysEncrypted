/****** Script for SelectTopNRows command from SSMS  ******/
CREATE DATABASE AlwaysEncrypted
use AlwaysEncrypted

SELECT TOP (1000) [Id]
      ,[Email]
      ,[Name]
  FROM [AlwaysEncrypted].[dbo].[Users]


CREATE COLUMN MASTER KEY DotNetLocalColumnMasterKey  
WITH (  
    KEY_STORE_PROVIDER_NAME = N'APP_SETTINGS_KEY_VAULT',  
    KEY_PATH = N'Some path -_-'
);

CREATE COLUMN MASTER KEY [TestEnclaveMasterKey]
WITH
(
	KEY_STORE_PROVIDER_NAME = N'MSSQL_CERTIFICATE_STORE',
	KEY_PATH = N'CurrentUser/My/8E3D810093B41A7C9E4F4461B439C75FA587C392',
	ENCLAVE_COMPUTATIONS (SIGNATURE = 0x8E8525EC31EF137BB6F093F660E4C0EDCB51274AE22AF193A8342F9E062BC7C2B9AD52E44C16DD236C5D68281A92ADD3BFF687DE0471BFEB853B66A624E4F327B108388F6F1B1FE7883C491B13957E902846C5BC9DBFB7A322F153B79145499004C5F9FB58C222C443A71C307F66F5D0109F5957DBE6E8D1B8FC302F2E8AD26E81D4FA0EC7F0202A8983ECAEE5FC95EB18AE3187D3206400FCE2C2C52DBCC2237916224F1E93F2834A6B1DB22E408142024EAC7AF72294B861ADCF2838CE45346937B7D47F2597ABF87A8E3C91220FE1EB22EAD70448CD0C086218712274E0BEAF255B5AB9C55637A2D81DCCC339D2C6120AEE4C4F72989292CADBAC8D554C2C)
)
GO

CREATE COLUMN ENCRYPTION KEY [TestEnclaveEncrypKey]
WITH VALUES
(
	COLUMN_MASTER_KEY = [TestEnclaveMasterKey],
	ALGORITHM = 'RSA_OAEP',
	ENCRYPTED_VALUE = 0x016E000001630075007200720065006E00740075007300650072002F006D0079002F00380065003300640038003100300030003900330062003400310061003700630039006500340066003400340036003100620034003300390063003700350066006100350038003700630033003900320042FA0D14A9BC029AF9FED14BED16AD5415AB70BB6814854ADFF281E00626754155072D7783DF24F91E1F69922F5FDA6F349DCD3117FBB49A3D4A1FC0DEEADC694208696F457AAD47131EBA55AC8D77E3A95F51328545605D9EC56DB9C2752780DE69D67677885FEE891E8D9850E475DE9CE3A58F10B5B323A82556D13B2B543C05C9776EDF9EB2FD2FA64A65239D6CEC7C5DFD44669F456661362698DBDB42B3A68892C3D2AB57FC85E97C1A0A03AD7822A5F76E31A77D5BD3D60406C271001E63480427815F6FD32497010AEF0A8A452A35D368FF8D666ECE8D904BB913664FD13166F914B6E8A3CE55FB32118F630BFD17F21C00C5C6936827AE5D10A39F65BA0C32EC1F039386ED7CB85E45F1A371D5BAFBC5CF568AAD2C868CBC2CC4CBA89DF3A1D20D42E27B8549E46808BDB0210E8E6B4204F9AC30D2E6666E3C5C76014F3BDC204DC999EA2D196B1FDA882519AA764CFD38D6DD755EA45452CB73A9FBE791477E9B3FA19194B45A4BB648099222E57DC0698723B52D402E00072653904CA7349E1199AA8258A739832CA8F89F36C405F6862BA3AAD0664BE73213791D08C964399BD5B794FDE261C6E735D278D8472AAC92008D5E837D53F4610885466BC70B3C7B3507720CF9B32BE6F6B1443DA062FD2E68112DFD6F38B9AC52EE75D671CBD870ED21C7E3B15D1A05CB2A9C15F99B2D454A93A3C89DB3C15E84FA88
)
GO

select * from sys.column_master_keys

--Master key: 1C92F1DAE3CC5E54DF576296C3CCFD8BD347DC52DE5153F108C7110EA71DD5F9
--Master key b64: HJLx2uPMXlTfV2KWw8z9i9NH3FLeUVPxCMcRDqcd1fk=
--Encryption key: A981CC4D0A55129009276AA37C774DC222F7A55F7D8C6C740504393F787A5DFA
--Encryption key b64: qYHMTQpVEpAJJ2qjfHdNwiL3pV99jGx0BQQ5P3h6Xfo=
--Enc Encryption key: B4FEC438EB4C742562FFF69BC502BD39F07737F45692A6A95B5DDAD0E6FC9C18
--Enc Encryption key b64: tP7EOOtMdCVi//abxQK9OfB3N/RWkqapW13a0Ob8nBg=

create COLUMN ENCRYPTION KEY DotNetLocalColumnEncKey   
WITH VALUES  
  (  
    COLUMN_MASTER_KEY = DotNetLocalColumnMasterKey,   
    ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256',   
    ENCRYPTED_VALUE = 0xB4FEC438EB4C742562FFF69BC502BD39F07737F45692A6A95B5DDAD0E6FC9C18
  )   
  
select * from sys.column_encryption_key_values
select * from sys.column_encryption_keys

DROP TABLE [dbo].[Users]

create TABLE [dbo].[Users](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[Email] [nvarchar](50) ENCRYPTED WITH (ENCRYPTION_TYPE = Randomized , ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', COLUMN_ENCRYPTION_KEY = [TestEnclaveEncrypKey]) null,
	[Name] [nchar](50) NULL
) ON [PRIMARY]
GO

INSERT INTO [dbo].[Users] ([Email], [Name])
values ('test', 'test')
 

drop TABLE [dbo].[Users](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[Email] [nchar](4000) NULL,
	[Name] [nchar](4000) NULL
) ON [PRIMARY]
GO

select * from Users where email like 'Aboba%'

sp_configure 'column encryption enclave type', 1;  
GO  
RECONFIGURE;  
GO  

SELECT * FROM sys.dm_column_encryption_enclave;  

USE [master];
GO
SELECT
[value]
, CASE [value] WHEN 0 THEN 'No enclave' WHEN 1 THEN 'VBS' ELSE 'Other' END AS [value_description]
, [value_in_use]
, CASE [value_in_use] WHEN 0 THEN 'No enclave' WHEN 1 THEN 'VBS' ELSE 'Other' END AS [value_in_use_description]
FROM sys.configurations
WHERE [name] = 'column encryption enclave type'; 

DROP TABLE [dbo].[Users]

create TABLE [dbo].[Users](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[Email] [nchar](30) ENCRYPTED WITH (ENCRYPTION_TYPE = Randomized , ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256', COLUMN_ENCRYPTION_KEY = DotNetLocalColumnEncKey) NULL,
	[Name] [nchar](4000) NULL
) ON [PRIMARY]
GO

CurrentUser/My/8E3D810093B41A7C9E4F4461B439C75FA587C392